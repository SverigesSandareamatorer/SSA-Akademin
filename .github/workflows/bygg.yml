name: Bygg KonCEPT

on:
  push:
    branches:
      - master
  pull_request:
    branches:
      - master

jobs:
  bygg-pdf:
    name: 'Bygg bok'
    runs-on: ubuntu-22.04
    steps:
      - name: 'Checka ut'
        uses: actions/checkout@v3
      - name: 'Installera'
        run: |
          sudo apt-get -q update
          sudo apt-get -q -y install texlive \
            texlive-lang-european texlive-science \
            texlive-fonts-recommended texlive-fonts-extra \
            language-pack-sv
      - name: 'Sätt systemspråk till svenska'
        run: |
          sudo locale-gen sv_SE.UTF-8
          sudo localectl set-locale LANG="sv_SE.UTF-8"
      - name: 'Kopiera info om repository'
        run: |
          echo $GITHUB_SHA | cut -c1-7 > SHA.tmp
          echo $GITHUB_REF_NAME > branch.tmp
      - name: 'Bygg'
        run: make koncept.pdf
      - name: 'Beräkna checksumma'
        run: sha256sum koncept.pdf
      - name: 'Byt namn'
        run: mv koncept.pdf koncept.$(cat VERSION.txt)+b${{ github.run_id }}.$(cat SHA.tmp).pdf
      - name: 'Skapa rapporter'
        run: |
          make images_linked
          make images_unlinked
          make TODOs
      - name: 'Ladda upp artefakt'
        uses: actions/upload-artifact@v3
        with:
          name: koncept-pdf
          path: koncept*.pdf
          retention-days: 31
      - name: 'Ladda upp rapporter'
        uses: actions/upload-artifact@v3
        with:
          name: rapporter
          path: |
            images_linked.txt
            images_unlinked.txt
            TODOs.txt
  testa-hyperlankar:
    name: 'Testa hyperlänkar'
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v3
      - name: lychee cache
        uses: actions/cache@v3
        with:
          path: .lycheecache
          key: cache-lychee-${{ github.sha }}
          restore-keys: cache-lychee-
      - name: Testa hyperlänkar
        uses: lycheeverse/lychee-action@v1.5.4
        with:
          fail: true
          args: "--cache --max-cache-age 2d --no-progress './**/*.md' './**/*.tex' './**/*.bib'"
